<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iFactory - Hệ thống Quản lý Sản xuất</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --brand-primary: #0D47A1; --brand-primary-hover: #0B3A80; --brand-secondary: #E3F2FD;
            --text-primary: #1e293b; --text-secondary: #64748b;
            --bg: #f1f5f9; --panel: #ffffff; --text: var(--text-primary); --muted: var(--text-secondary);
            --primary: var(--brand-primary); --danger: #dc2626; --grid: #e5e7eb; --chip: var(--brand-secondary);
            --focus: #1d4ed8; --warning: #f59e0b; --success: #16a34a; --radius: 10px;
            --shadow: 0 4px 12px rgba(0,0,0,.08); --station-h: 72px; --track-h: 56px; --col-w: 80px;
        }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); }
        .app-container { display: flex; height: 100vh; }
        .sidebar { background-color: var(--brand-primary); transition: width 0.3s ease-in-out; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; white-space: nowrap; border-radius: 0.375rem; color: #BBDEFB; transition: all 0.2s; font-weight: 500; }
        .sidebar-link:hover { background-color: var(--brand-primary-hover); color: #ffffff; }
        .sidebar-link.active { background-color: #ffffff; color: var(--brand-primary); font-weight: 600; }
        .sidebar-link i { font-size: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; }
        
        .sidebar-collapsed .sidebar { width: 80px; }
        .sidebar-collapsed .sidebar-link span, .sidebar-collapsed .sidebar-header-text, .sidebar-collapsed .user-info, .sidebar-collapsed .config-header { display: none; }
        .sidebar-collapsed .sidebar-link, .sidebar-collapsed .sidebar-header { justify-content: center; }
        .sidebar-collapsed .sidebar-link i { margin-right: 0; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .schedule-view { display: none; }
        .schedule-view.active { display: block; }
        
        .tab-btn { padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; border-bottom: 2px solid transparent; color: var(--text-secondary); cursor: pointer; }
        .tab-btn.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }

        .panel { background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px; border: 1px solid var(--grid); }
        .field{display:flex;flex-direction:column;gap:6px}
        .label{font-size:12px;color:var(--muted)}
        .input, .select{ height:36px;border:1px solid #d1d5db;border-radius:8px;padding:0 10px;background:#fff; outline:none; font-size: 14px; }
        .input:focus, .select:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(29,78,216,.15)}
        .toolbar{ display:flex;align-items:center;justify-content:space-between;margin-top:16px;gap:12px;flex-wrap:wrap; }
        .left, .right{display:flex;align-items:center;gap:8px}
        .btn{ height:36px;padding:0 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer; display:inline-flex;align-items:center;gap:8px;font-weight:600; }
        .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
        .btn.ghost{background:transparent;border-color:transparent;color:#374151}
        .segmented{ display:inline-flex;border:1px solid #d1d5db;border-radius:10px;overflow:hidden; }
        .segmented button{ height:36px;padding:0 12px;border:0;background:#fff;cursor:pointer;font-weight:600; }
        .segmented button.active{background:var(--chip);color:var(--focus)}
        .date{ display:inline-flex;align-items:center;gap:4px;border:1px solid #d1d5db;border-radius:8px;height:36px;background:#fff; }
        .date input { border: none !important; box-shadow: none !important; text-align: center; }
        
        .schedule{ background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow); overflow:hidden; border: 1px solid var(--grid); }
        .schedule-head{ display:grid; grid-template-columns:240px 1fr; border-bottom:1px solid var(--grid); background: #f8fafc; }
        .stations-head{ padding:12px 16px;font-weight:700;color:#1f2937;border-right:1px solid var(--grid); }
        .timehead{ position:relative;overflow:hidden;white-space:nowrap; }
        .time-grid{ display:flex;position:relative; }
        .time-col{ width:var(--col-w);min-width:var(--col-w);border-left:1px solid var(--grid); padding:8px 0;text-align:center;color:var(--muted);font-size:12px; }
        .schedule-body{ display:grid;grid-template-columns:240px 1fr;max-height:66vh;overflow:auto; }
        .stations{ border-right:1px solid var(--grid);background:#fdfdff; }
        .station{ height:var(--station-h);display:flex;align-items:center;gap:8px;padding:0 16px;border-bottom:1px solid var(--grid); }
        .badge{ background:var(--chip);color:#3730a3;font-weight:700;border-radius:999px;padding:4px 10px;font-size:12px; }
        .station-sub{color:var(--muted);font-size:12px}
        
        .tracks{ position:relative; }
        .track{ position:relative;height:var(--station-h);border-bottom:1px solid var(--grid); }
        .track-timeline { background: repeating-linear-gradient( to right, transparent 0 calc(var(--col-w) - 1px), #f6f8fb calc(var(--col-w) - 1px) var(--col-w)); }
        .track.drop-hover { background-color: #e0e7ff; }
        .unscheduled-track { display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; padding: 8px; min-height: var(--station-h); }

        .now{ position:absolute;top:0;bottom:0;width:2px;background:var(--danger);box-shadow:0 0 0 2px rgba(220,38,38,.15); z-index:5;pointer-events:none; }
        
        .order { position:absolute;height:var(--track-h);top:8px;border-radius:8px;display:flex;align-items:center; padding:8px 10px;gap:8px;color:#fff;font-weight:600;box-shadow:0 4px 14px rgba(0,0,0,.15);cursor:pointer; user-select: none; }
        .order.dragging { opacity: 0.5; }
        
        .order.blue{background:linear-gradient(135deg,#2563eb,#1d4ed8)}
        .order.red{background:linear-gradient(135deg,#ef4444,#dc2626)}
        .order.yellow{background:linear-gradient(135deg,#f59e0b,#d97706)}
        .order.green{background:linear-gradient(135deg,#16a34a,#15803d)}
        .order.grey {background:linear-gradient(135deg,#94a3b8,#64748b)}
        
        .modal { background-color: rgba(0,0,0,0.5); z-index: 100; }
        .modal-content { animation: slideInUp 0.3s ease-out; }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .status-badge { padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; text-align: center; display: inline-block; }
        .status-badge.grey { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .status-badge.blue { background-color: #dbeafe; color: #2563eb; }
        .status-badge.yellow { background-color: #fef9c3; color: #ca8a04; }
        .status-badge.red { background-color: #fee2e2; color: #dc2626; }
        .status-badge.green { background-color: #dcfce7; color: #16a34a; }
        
        .plan-table th, .work-schedule-table th { padding: 8px 12px; }
        .plan-table td, .work-schedule-table td { padding: 10px 12px; white-space: nowrap; }
        .plan-table .month-row { cursor: pointer; }
        .plan-table .month-row:hover { background-color: #f8fafc; }
        .plan-table .month-row i { transition: transform 0.2s; }
        .plan-table .month-row.collapsed i { transform: rotate(-90deg); }
        .plan-table .metric-row-l2 { padding-left: 2.5rem !important; }
        .plan-table .metric-row-l3 { padding-left: 4rem !important; }
        .plan-table .total-row td { font-weight: 700; color: var(--brand-primary); }
    </style>
</head>
<body class="">

    <div class="app-container">
        <aside class="sidebar w-64 text-white p-4 flex flex-col shrink-0">
            <div class="sidebar-header flex items-center mb-10">
                <i class="ph-bold ph-factory text-3xl text-white"></i>
                <span class="sidebar-header-text text-2xl font-bold ml-2">iFactory</span>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="sidebar-link active" data-page="dashboard"><i class="ph ph-gauge"></i><span class="link-text">Dashboard</span></a>

                <div>
                    <span class="config-header px-5 pt-6 pb-2 text-xs font-semibold text-blue-200 uppercase tracking-wider">Cấu hình</span>
                    <div class="flex flex-col space-y-2 mt-2">
                        <a href="#" class="sidebar-link" data-page="item-master"><i class="ph ph-package"></i><span class="link-text">Danh mục hàng hóa</span></a>
                        <a href="#" class="sidebar-link" data-page="bom-config"><i class="ph ph-list-bullets"></i><span class="link-text">Cấu hình BOM</span></a>
                        <a href="#" class="sidebar-link" data-page="station-config"><i class="ph ph-robot"></i><span class="link-text">Cấu hình Trạm SX</span></a>
                        <a href="#" class="sidebar-link" data-page="inventory-update"><i class="ph ph-stack"></i><span class="link-text">Cập nhật tồn kho</span></a>
                    </div>
                </div>

                <div>
                    <span class="config-header px-5 pt-6 pb-2 text-xs font-semibold text-blue-200 uppercase tracking-wider">Kế hoạch sản xuất</span>
                    <div class="flex flex-col space-y-2 mt-2">
                        <a href="#" class="sidebar-link" data-page="production-plan"><i class="ph ph-calendar-plus"></i><span class="link-text">Kế hoạch sản xuất</span></a>
                        <a href="#" class="sidebar-link" data-page="order-list"><i class="ph ph-notepad"></i><span class="link-text">Lệnh sản xuất</span></a>
                        <a href="#" class="sidebar-link" data-page="scheduling"><i class="ph ph-calendar-check"></i><span class="link-text">Lập lịch sản xuất</span></a>
                    </div>
                </div>
            </nav>
            <div class="mt-auto">
                <div class="user-profile flex items-center p-3 bg-black bg-opacity-20 rounded-lg">
                    <img src="https://placehold.co/40x40/BBDEFB/0D47A1?text=QM" alt="Avatar" class="rounded-full flex-shrink-0">
                    <div class="user-info ml-3"><p class="font-semibold text-sm text-white">Quang Minh</p><p class="text-xs text-blue-200">Quản lý Sản xuất</p></div>
                </div>
                <button id="sidebarToggle" class="w-full mt-4 flex items-center justify-center p-2 rounded-lg hover:bg-black hover:bg-opacity-20 transition-colors">
                    <i class="ph ph-caret-double-left text-xl"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto">

            <div id="dashboard" class="page active">
                 <h1 class="text-3xl font-bold text-text-primary mb-2">Báo cáo Tiến độ Sản xuất</h1>
                 <p class="text-text-secondary mb-6">Tổng quan về hiệu suất và tiến độ sản xuất trong nhà máy.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                     <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-sm font-medium text-text-secondary">Hiệu suất (OEE)</h3><p class="text-3xl font-bold text-green-600 mt-2">85.6%</p></div>
                     <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-sm font-medium text-text-secondary">Tổng sản lượng</h3><p class="text-3xl font-bold text-blue-700 mt-2">12,480 <span class="text-lg font-medium text-text-secondary">sp</span></p></div>
                     <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-sm font-medium text-text-secondary">Lệnh sản xuất</h3><p class="text-3xl font-bold text-text-primary mt-2">42 <span class="text-lg font-medium text-text-secondary">/ 50</span></p></div>
                     <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-sm font-medium text-text-secondary">Tỷ lệ lỗi</h3><p class="text-3xl font-bold text-red-600 mt-2">1.2%</p></div>
                 </div>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                     <div class="lg:col-span-3 bg-white p-6 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-lg font-semibold text-text-primary mb-4">Sản lượng theo Trạm sản xuất</h3><div class="h-80"><canvas id="productionByStationChart"></canvas></div></div>
                     <div class="lg:col-span-2 bg-white p-6 rounded-lg border border-slate-200 shadow-sm"><h3 class="text-lg font-semibold text-text-primary mb-4">Trạng thái lệnh sản xuất</h3><div class="h-80"><canvas id="orderStatusChart"></canvas></div></div>
                 </div>
            </div>

            <div id="scheduling" class="page">
                 <div class="border-b border-gray-200 mb-4 flex justify-between items-center">
                     <div class="flex space-x-4">
                         <button class="tab-btn active" data-view="gantt-view">Lịch sản xuất</button>
                         <button class="tab-btn" data-view="kanban-view">Danh sách chi tiết</button>
                     </div>
                 </div>

                 <div class="panel !py-3 !px-4 mb-4">
                    <div class="flex items-center gap-x-6 gap-y-2 flex-wrap">
                        <span class="font-semibold text-sm mr-2">Chú giải:</span>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-300"></div><span class="text-xs font-medium text-slate-600">Chưa xếp lịch</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-500"></div><span class="text-xs font-medium text-slate-600">Chưa bắt đầu</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-600"></div><span class="text-xs font-medium text-slate-600">Đang thực hiện</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><span class="text-xs font-medium text-slate-600">Cảnh báo</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-600"></div><span class="text-xs font-medium text-slate-600">Chậm tiến độ</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-600"></div><span class="text-xs font-medium text-slate-600">Hoàn thành</span></div>
                    </div>
                </div>

                 <div id="gantt-view" class="schedule-view active">
                     <section class="panel">
                         <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                             <div class="flex items-center gap-4 flex-wrap">
                                 <div class="date">
                                     <button class="btn ghost" id="prevDay">◀</button>
                                     <input type="date" class="input !h-auto" id="dateHead" />
                                     <button class="btn ghost" id="nextDay">▶</button>
                                 </div>
                                 <div class="segmented">
                                     <button class="active" data-range="24h">24h</button>
                                     <button data-range="shift1">Ca 1</button>
                                     <button data-range="shift2">Ca 2</button>
                                     <button data-range="shift3">Ca 3</button>
                                 </div>
                             </div>
                             <div class="flex items-center gap-2">
                                 <button class="btn primary" id="addOrderBtn"><i class="ph ph-plus"></i> Thêm Lệnh Mới</button>
                             </div>
                         </div>
                         
                         <hr class="border-t border-slate-200 -mx-4 mb-4">

                         <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                             <div class="field"><label class="label" for="dvcs">Mã ĐVCS</label><input id="dvcs" class="input" value="004" /></div>
                             <div class="field"><label class="label" for="soct">Số CT</label><input id="soct" class="input" placeholder="VD: 004-WO1-..." /></div>
                             <div class="field"><label class="label" for="phanxuong">Phân xưởng</label><select id="phanxuong" class="select"><option>PX1</option><option>PX2</option></select></div>
                             <div class="field"><label class="label" for="to">Mã tổ</label><input id="to" class="input" placeholder="VD: TO01" /></div>
                             <div class="field"><label class="label" for="trangthai">Trạng thái</label><select id="trangthai" class="select"><option value="all">Tất cả</option><option value="blue">Đang làm</option></select></div>
                         </div>
                     </section>
                     
                     <section class="schedule">
                           <div class="toolbar !mt-0 p-2 border-b justify-end">
                             <div class="right flex items-center gap-4">
                                 <div class="zoom">
                                     <span class="label">Thu phóng</span>
                                     <input type="range" id="zoom" min="60" max="140" step="4" value="100" class="w-24 md:w-40">
                                 </div>
                             </div>
                         </div>
                         <div class="schedule-head">
                             <div class="stations-head">Trạm sản xuất</div>
                             <div class="timehead" id="timeHeadScroll"><div class="time-grid" id="timeGrid"></div></div>
                         </div>
                         <div class="schedule-body">
                             <div class="stations" id="stations"></div>
                             <div class="tracks" id="tracks"><div class="now" id="nowMarker"></div></div>
                         </div>
                     </section>
                     <section id="unscheduled-panel" class="panel mt-4">
                         <h3 class="font-semibold text-text-primary mb-3">Lệnh sản xuất chưa xếp lịch</h3>
                         <div id="unscheduled-dropzone" class="unscheduled-track bg-slate-50 border border-dashed rounded-lg"></div>
                     </section>
                 </div>
                 <div id="kanban-view" class="schedule-view">
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          <div>
                            <h3 class="font-semibold text-slate-700 mb-4">Chưa xếp lịch (<span id="kanban-count-unscheduled">0</span>)</h3>
                            <div id="kanban-col-unscheduled" class="space-y-3 min-h-[100px] bg-slate-100 p-2 rounded-lg"></div>
                          </div>
                          <div>
                            <h3 class="font-semibold text-slate-700 mb-4">Chưa bắt đầu (<span id="kanban-count-grey">0</span>)</h3>
                            <div id="kanban-col-grey" class="space-y-3 min-h-[100px] bg-slate-100 p-2 rounded-lg"></div>
                          </div>
                          <div>
                            <h3 class="font-semibold text-slate-700 mb-4">Đang làm & Cần chú ý (<span id="kanban-count-active">0</span>)</h3>
                            <div id="kanban-col-active" class="space-y-3 min-h-[100px] bg-slate-100 p-2 rounded-lg"></div>
                          </div>
                          <div>
                            <h3 class="font-semibold text-slate-700 mb-4">Hoàn thành (<span id="kanban-count-green">0</span>)</h3>
                            <div id="kanban-col-green" class="space-y-3 min-h-[100px] bg-slate-100 p-2 rounded-lg"></div>
                          </div>
                      </div>
                 </div>
            </div>
            <div id="bom-config" class="page">
                 <h1 class="text-3xl font-bold text-text-primary mb-6">Cấu hình BOM (Định mức nguyên vật liệu)</h1>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <div class="md:col-span-1 bg-white p-4 rounded-lg border">
                         <div class="flex justify-between items-center mb-2">
                             <h2 class="text-lg font-semibold">Danh sách thành phẩm</h2>
                             <button id="addBomBtn" class="btn primary text-sm !h-9"><i class="ph ph-plus"></i>Thêm</button>
                         </div>
                         <input type="search" id="bomSearch" class="input w-full mb-4" placeholder="Tìm theo mã hoặc tên...">
                         <div id="productList" class="flex flex-col space-y-2 max-h-[60vh] overflow-y-auto"></div>
                     </div>
                     <div class="md:col-span-2 bg-white p-4 rounded-lg border">
                          <div id="bomDetailView" class="hidden">
                             <div class="flex justify-between items-center mb-4">
                                 <div>
                                     <h2 class="text-lg font-semibold">BOM cho: <span id="bomProductName" class="text-blue-700"></span></h2>
                                     <p class="text-sm text-gray-500">Mã: <span id="bomProductCode"></span></p>
                                 </div>
                                 <button id="editBomBtn" class="btn text-sm !h-9"><i class="ph ph-pencil-simple"></i>Sửa</button>
                             </div>
                             <table class="w-full text-sm text-left">
                                 <thead class="bg-slate-50 text-xs uppercase"><tr><th class="p-2">Mã NVL</th><th class="p-2">Tên Nguyên vật liệu</th><th class="p-2">Số lượng</th><th class="p-2">Đơn vị</th></tr></thead>
                                 <tbody id="bomComponentList"></tbody>
                             </table>
                        </div>
                         <div id="bomEmptyView" class="text-center text-gray-500 py-10"><p>Chọn một thành phẩm để xem BOM.</p></div>
                     </div>
                 </div>
            </div>

            <div id="station-config" class="page">
                 <h1 class="text-3xl font-bold text-text-primary mb-6">Cấu hình Trạm sản xuất</h1>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div class="md:col-span-1 bg-white p-4 rounded-lg border">
                          <div class="flex justify-between items-center mb-2">
                              <h2 class="text-lg font-semibold">Danh sách trạm</h2>
                              <button id="addStationBtn" class="btn primary text-sm !h-9"><i class="ph ph-plus"></i>Thêm</button>
                          </div>
                          <input type="search" id="stationSearch" class="input w-full mb-4" placeholder="Tìm theo mã hoặc tên...">
                          <div id="stationList" class="flex flex-col space-y-2 max-h-[70vh] overflow-y-auto"></div>
                      </div>
                     <div class="md:col-span-2 bg-white p-4 rounded-lg border">
                          <div id="stationDetailView" class="hidden">
                                  <div class="flex justify-between items-center mb-6">
                                      <h2 class="text-lg font-semibold">Chi tiết trạm sản xuất</h2>
                                      <button id="editStationBtn" class="btn primary text-sm !h-9"><i class="ph ph-pencil-simple"></i>Sửa</button>
                                  </div>
                                  <div class="grid grid-cols-2 gap-4">
                                      <div class="field"><p class="label">Mã Trạm</p><p class="font-semibold" id="stationDetailId"></p></div>
                                      <div class="field"><p class="label">Tên Trạm</p><p class="font-semibold" id="stationDetailName"></p></div>
                                      <div class="field"><p class="label">Phân xưởng</p><p class="font-semibold" id="stationDetailWorkshop"></p></div>
                                      <div class="field"><p class="label">Hiệu suất mục tiêu (%)</p><p class="font-semibold" id="stationDetailEfficiency"></p></div>
                                      <div class="field col-span-2"><p class="label">Công suất (Sản phẩm / giờ)</p><p class="font-semibold" id="stationDetailCapacity"></p></div>
                                  </div>
                                  <div class="mt-6 pt-4 border-t">
                                     <h3 class="text-md font-semibold mb-3">Lịch làm việc tiêu chuẩn</h3>
                                     <div id="stationWorkSchedule" class="overflow-x-auto"></div>
                                  </div>
                         </div>
                          <div id="stationEmptyView" class="text-center text-gray-500 py-10"><p>Chọn một trạm sản xuất để xem chi tiết.</p></div>
                     </div>
                 </div>
            </div>

            <div id="item-master" class="page">
                <h1 class="text-3xl font-bold text-text-primary mb-2">Danh mục Hàng hóa, Vật tư</h1>
                <p class="text-text-secondary mb-6">Quản lý toàn bộ hàng hóa, nguyên vật liệu và thành phẩm.</p>
                <div class="panel">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="field md:col-span-2"><label class="label">Tên hàng hóa, vật tư</label><input class="input" placeholder="Nhập tên hoặc mã..."></div>
                        <div class="field"><label class="label">Loại hàng hóa</label><select class="select"><option>Tất cả</option><option>Thành phẩm</option><option>Nguyên vật liệu</option></select></div>
                        <div class="field"><label class="label">Nhóm hàng hóa</label><select class="select"><option>Tất cả</option><option>Vật liệu kim loại</option><option>Vật liệu nhựa</option></select></div>
                        <div class="field"><label class="label">Trạng thái</label><select class="select"><option>Tất cả</option><option>Hoạt động</option><option>Không hoạt động</option></select></div>
                    </div>
                </div>
                <div class="panel !p-0">
                    <div class="p-4 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-text-primary">Danh sách</h2>
                        <button class="btn primary"><i class="ph ph-plus"></i><span>Thêm mới</span></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600 uppercase text-xs">
                                <tr>
                                    <th class="p-3 font-semibold w-12 text-center">STT</th>
                                    <th class="p-3 font-semibold">Mã Hàng hóa</th>
                                    <th class="p-3 font-semibold">Tên Hàng hóa</th>
                                    <th class="p-3 font-semibold">Đơn vị</th>
                                    <th class="p-3 font-semibold">Loại</th>
                                    <th class="p-3 font-semibold">Nhóm</th>
                                    <th class="p-3 font-semibold text-center">Trạng thái</th>
                                    <th class="p-3 font-semibold">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                <tr class="hover:bg-slate-50">
                                    <td class="p-3 text-center">1</td>
                                    <td class="p-3 font-semibold text-slate-800 font-mono">NVL-01</td>
                                    <td class="p-3">Thép tấm 1.2mm</td>
                                    <td class="p-3">kg</td>
                                    <td class="p-3">Nguyên vật liệu</td>
                                    <td class="p-3">Vật liệu kim loại</td>
                                    <td class="p-3 text-center"><span class="status-badge green">Hoạt động</span></td>
                                    <td class="p-3"><button class="btn !h-8 !px-2"><i class="ph ph-pencil-simple"></i></button></td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="p-3 text-center">2</td>
                                    <td class="p-3 font-semibold text-slate-800 font-mono">SP-A</td>
                                    <td class="p-3">Vỏ máy Standard</td>
                                    <td class="p-3">Cái</td>
                                    <td class="p-3">Thành phẩm</td>
                                    <td class="p-3">Sản phẩm hoàn thiện</td>
                                    <td class="p-3 text-center"><span class="status-badge green">Hoạt động</span></td>
                                    <td class="p-3"><button class="btn !h-8 !px-2"><i class="ph ph-pencil-simple"></i></button></td>
                                </tr>
                                 <tr class="hover:bg-slate-50">
                                    <td class="p-3 text-center">3</td>
                                    <td class="p-3 font-semibold text-slate-800 font-mono">NVL-02</td>
                                    <td class="p-3">Sơn tĩnh điện Xanh</td>
                                    <td class="p-3">lít</td>
                                    <td class="p-3">Nguyên vật liệu</td>
                                    <td class="p-3">Hóa chất</td>
                                    <td class="p-3 text-center"><span class="status-badge red">Không hoạt động</span></td>
                                    <td class="p-3"><button class="btn !h-8 !px-2"><i class="ph ph-pencil-simple"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="inventory-update" class="page">
                <h1 class="text-3xl font-bold text-text-primary mb-2">Báo cáo Tồn kho</h1>
                <p class="text-text-secondary mb-6">Theo dõi số lượng và giá trị hàng hóa trong tất cả các kho.</p>
                <div class="panel">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="field md:col-span-2"><label class="label">Tìm sản phẩm</label><input class="input" placeholder="Nhập tên hoặc mã sản phẩm..."></div>
                        <div class="field"><label class="label">Kho</label><select class="select"><option>Tất cả các kho</option><option>Kho Nguyên vật liệu</option><option>Kho Thành phẩm</option></select></div>
                        <div class="field"><label class="label">Danh mục sản phẩm</label><select class="select"><option>Tất cả</option><option>Vật liệu kim loại</option><option>Sản phẩm hoàn thiện</option></select></div>
                    </div>
                </div>
                <div class="panel !p-0">
                     <div class="p-4 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-text-primary">Chi tiết Tồn kho</h2>
                        <div class="flex items-center gap-2">
                             <button class="btn"><i class="ph ph-download-simple"></i><span>Xuất Excel</span></button>
                             <button class="btn primary"><i class="ph ph-arrows-clockwise"></i><span>Cập nhật</span></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600 uppercase text-xs">
                                <tr>
                                    <th class="p-3 font-semibold">Sản phẩm</th>
                                    <th class="p-3 font-semibold text-right">Đơn giá</th>
                                    <th class="p-3 font-semibold text-right">Tổng giá trị</th>
                                    <th class="p-3 font-semibold text-right">Tồn kho</th>
                                    <th class="p-3 font-semibold text-right">Có thể dùng</th>
                                    <th class="p-3 font-semibold text-right">Đang về</th>
                                    <th class="p-3 font-semibold text-right">Sắp đi</th>
                                </tr>
                            </thead>
                             <tbody class="divide-y divide-slate-200">
                                <tr class="hover:bg-slate-50">
                                    <td class="p-3"><p class="font-semibold text-slate-800">Vỏ máy Standard</p><p class="text-xs text-slate-500 font-mono">[SP-A]</p></td>
                                    <td class="p-3 text-right font-mono">550,000</td>
                                    <td class="p-3 text-right font-mono">82,500,000</td>
                                    <td class="p-3 text-right font-mono font-bold text-blue-700">150.00</td>
                                    <td class="p-3 text-right font-mono">120.00</td>
                                    <td class="p-3 text-right font-mono">50.00</td>
                                    <td class="p-3 text-right font-mono">30.00</td>
                                </tr>
                                 <tr class="hover:bg-slate-50">
                                    <td class="p-3"><p class="font-semibold text-slate-800">Thép tấm 1.2mm</p><p class="text-xs text-slate-500 font-mono">[NVL-01]</p></td>
                                    <td class="p-3 text-right font-mono">25,000</td>
                                    <td class="p-3 text-right font-mono">12,500,000</td>
                                    <td class="p-3 text-right font-mono font-bold text-blue-700">500.00</td>
                                    <td class="p-3 text-right font-mono">500.00</td>
                                    <td class="p-3 text-right font-mono">1000.00</td>
                                    <td class="p-3 text-right font-mono">0.00</td>
                                </tr>
                                <tr class="hover:bg-slate-50">
                                    <td class="p-3"><p class="font-semibold text-slate-800">Ốc M5</p><p class="text-xs text-slate-500 font-mono">[NVL-04]</p></td>
                                    <td class="p-3 text-right font-mono">200</td>
                                    <td class="p-3 text-right font-mono">2,000,000</td>
                                    <td class="p-3 text-right font-mono font-bold text-blue-700">10,000.00</td>
                                    <td class="p-3 text-right font-mono">8,500.00</td>
                                    <td class="p-3 text-right font-mono">0.00</td>
                                    <td class="p-3 text-right font-mono">1,500.00</td>
                                </tr>
                             </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="order-list" class="page">
                 <h1 class="text-3xl font-bold text-text-primary mb-2">Lệnh sản xuất</h1>
                 <p class="text-text-secondary mb-6">Quản lý và theo dõi tất cả các lệnh sản xuất trong hệ thống.</p>
                
                 <div class="panel !p-0">
                     <div class="p-4 flex justify-between items-center">
                         <div class="w-full max-w-xs">
                             <input type="search" id="orderListSearch" class="input w-full" placeholder="Tìm theo mã lệnh, sản phẩm...">
                         </div>
                         <button class="btn primary" id="addNewOrderFromListBtn">
                             <i class="ph ph-plus"></i>
                             <span>Thêm Lệnh Mới</span>
                         </button>
                     </div>
                     <div class="overflow-x-auto">
                         <table class="w-full text-sm text-left">
                             <thead class="bg-slate-50 text-slate-600 uppercase text-xs">
                                 <tr>
                                     <th class="p-3 font-semibold">Mã Lệnh</th>
                                     <th class="p-3 font-semibold">Sản phẩm</th>
                                     <th class="p-3 font-semibold">Số lượng</th>
                                     <th class="p-3 font-semibold">Trạm SX</th>
                                     <th class="p-3 font-semibold">Bắt đầu</th>
                                     <th class="p-3 font-semibold">Kết thúc</th>
                                     <th class="p-3 font-semibold text-center">Trạng thái</th>
                                     <th class="p-3 font-semibold">Hành động</th>
                                 </tr>
                             </thead>
                             <tbody id="orderListTableBody" class="divide-y divide-slate-200">
                                  </tbody>
                         </table>
                     </div>
                 </div>
            </div>

            <div id="production-plan" class="page">
                 <h1 class="text-3xl font-bold text-text-primary mb-2">Kế hoạch Sản xuất Tổng thể</h1>
                 <p class="text-text-secondary mb-6">Xem và điều chỉnh kế hoạch sản xuất cho các kỳ.</p>
                 <div class="panel">
                      <div class="flex flex-wrap items-center justify-between gap-4">
                          <div class="flex items-center gap-4">
                              <div class="field"><label class="label">Kế hoạch năm</label><select class="select w-40"><option>Kế hoạch năm 2025 (v1.0)</option></select></div>
                              <div class="field"><label class="label">Trạng thái</label><select class="select w-32"><option>Bản nháp</option><option>Chính thức</option></select></div>
                          </div>
                          <div class="flex items-center gap-2">
                               <button class="btn"><i class="ph ph-download-simple"></i><span>Tải xuống</span></button>
                               <button class="btn"><i class="ph ph-upload-simple"></i><span>Tải lên</span></button>
                               <button class="btn primary"><i class="ph ph-floppy-disk"></i><span>Lưu</span></button>
                          </div>
                      </div>
                 </div>
                 <div class="panel !p-0 overflow-x-auto">
                     <table class="w-full text-sm text-left plan-table">
                         <thead id="productionPlanThead" class="bg-sky-800 text-white text-xs uppercase">
                             </thead>
                         <tbody id="productionPlanTbody" class="divide-y divide-slate-200">
                             </tbody>
                     </table>
                 </div>
            </div>
             </main>
    </div>

    <div id="orderFormModal" class="modal fixed inset-0 flex items-center justify-center hidden"><div class="modal-content bg-white w-full max-w-lg rounded-lg shadow-xl"><form id="orderForm" class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-text-primary" id="orderFormModalTitle"></h2><button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><input type="hidden" name="editingId"><div class="grid grid-cols-2 gap-4"><div class="field"><label class="label">Mã Lệnh (LSX)</label><input name="id" class="input" required></div><div class="field"><label class="label">Sản phẩm</label><select name="product" class="select" required id="form-modal-product"></select></div><div class="field"><label class="label">Số lượng</label><input name="qty" type="number" class="input" required></div><div class="field"><label class="label">Trạm sản xuất</label><select name="station" class="select" id="form-modal-station"></select></div><div class="field"><label class="label">Thời gian bắt đầu (hh:mm)</label><input name="start" type="time" class="input"></div><div class="field"><label class="label">Thời gian kết thúc (hh:mm)</label><input name="end" type="time" class="input"></div><div class="field col-span-2"><label class="label">Trạng thái</label><select name="status" class="select"><option value="grey">Chưa bắt đầu</option><option value="blue">Đang thực hiện</option><option value="yellow">Cảnh báo</option><option value="red">Chậm tiến độ</option><option value="green">Hoàn thành</option></select></div><div class="field col-span-2"><label class="label">Lý do (nếu có)</label><input name="reason" class="input"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="close-modal-btn btn">Hủy</button><button type="submit" class="btn primary">Lưu Lệnh</button></div></form></div></div>
    <div id="stationFormModal" class="modal fixed inset-0 flex items-center justify-center hidden"><div class="modal-content bg-white w-full max-w-lg rounded-lg shadow-xl"><form id="stationForm" class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-text-primary" id="stationFormModalTitle"></h2><button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><input type="hidden" name="editingId"><div class="grid grid-cols-2 gap-4"><div class="field"><label class="label">Mã Trạm</label><input name="id" class="input" required></div><div class="field"><label class="label">Tên Trạm</label><input name="name" class="input" required></div><div class="field"><label class="label">Phân xưởng</label><input name="workshop" class="input"></div><div class="field"><label class="label">Hiệu suất mục tiêu (%)</label><input name="efficiency" type="number" class="input"></div><div class="field"><label class="label">Lịch làm việc</label><select name="scheduleId" class="select"></select></div><div class="field"><label class="label">Công suất (Sản phẩm / giờ)</label><input name="capacity" type="number" class="input"></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="close-modal-btn btn">Hủy</button><button type="submit" class="btn primary">Lưu Trạm</button></div></form></div></div>
    <div id="bomFormModal" class="modal fixed inset-0 flex items-center justify-center hidden"><div class="modal-content bg-white w-full max-w-2xl rounded-lg shadow-xl"><form id="bomForm" class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-text-primary" id="bomFormModalTitle"></h2><button type="button" class="close-modal-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><input type="hidden" name="editingCode"><div class="grid grid-cols-2 gap-4 mb-4"><div class="field"><label class="label">Mã Thành phẩm</label><select name="code" class="select" required></select></div><div class="field"><label class="label">Tên Thành phẩm</label><input name="name" class="input" required></div></div><h3 class="font-semibold mb-2">Nguyên vật liệu</h3><div id="bom-components-container" class="space-y-2 max-h-48 overflow-y-auto p-2 border rounded-md bg-slate-50"></div><button type="button" id="addBomComponentBtn" class="btn text-sm mt-2"><i class="ph ph-plus"></i>Thêm NVL</button><div class="mt-6 flex justify-end space-x-3"><button type="button" class="close-modal-btn btn">Hủy</button><button type="submit" class="btn primary">Lưu BOM</button></div></form></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA MODELS (EXPANDED) ---
        let workingSchedules = {
            'HC': { 
                name: 'Hành chính (8h/ngày)',
                periods: [
                    { name: 'Ca HC Sáng', day: 'Thứ 2 - Thứ 6', period: 'Sáng', from: '08:00', to: '12:00'},
                    { name: 'Ca HC Chiều', day: 'Thứ 2 - Thứ 6', period: 'Chiều', from: '13:00', to: '17:00'},
                    { name: 'Ca T7 Sáng', day: 'Thứ 7', period: 'Sáng', from: '08:00', to: '12:00'}
                ]
            },
            '3CA': {
                name: 'Sản xuất 3 ca (24/7)',
                periods: [
                    { name: 'Ca 1', day: 'Hàng ngày', period: 'Ca 1', from: '06:00', to: '14:00' },
                    { name: 'Ca 2', day: 'Hàng ngày', period: 'Ca 2', from: '14:00', to: '22:00' },
                    { name: 'Ca 3', day: 'Hàng ngày', period: 'Ca 3', from: '22:00', to: '06:00' }
                ]
            }
        };

        let stationsData = [
            { id:'TSX-01', name:'Trạm tiền xử lý 1', workshop: 'PX1', efficiency: 95, capacity: 100, scheduleId: '3CA' },
            { id:'TSX-02', name:'Trạm tiền xử lý 2', workshop: 'PX1', efficiency: 90, capacity: 80, scheduleId: '3CA' },
            { id:'TSX-03', name:'Trạm lắp ráp A', workshop: 'PX2', efficiency: 98, capacity: 110, scheduleId: '3CA' },
            { id:'TSX-04', name:'Trạm KCS', workshop: 'PX2', efficiency: 100, capacity: 200, scheduleId: 'HC' },
            { id:'UNS-01', name:'Chưa xếp lịch', unscheduled: true },
        ];
        
        let productsData = [
            { code: 'SP-A', name: 'Vỏ máy Standard', components: [{code: 'NVL-01', name: 'Thép tấm 1.2mm', qty: 10, unit: 'kg'}, {code: 'NVL-02', name: 'Sơn tĩnh điện Xanh', qty: 5, unit: 'lít'}] },
            { code: 'SP-C', name: 'Khung máy Pro', components: [{code: 'NVL-03', name: 'Nhôm định hình 20x20', qty: 8, unit: 'm'}, {code: 'NVL-04', name: 'Ốc M5', qty: 20, unit: 'cái'}] },
            { code: 'SP-D', name: 'Sản phẩm D', components: [] }, { code: 'SP-E', name: 'Sản phẩm E', components: [] },
            { code: 'SP-F', name: 'Sản phẩm F', components: [] }, { code: 'SP-G', name: 'Sản phẩm G', components: [] },
        ];

        let ordersData = [
            { id:'DH-0001', station:'TSX-01', start: 7*60+30, end: 11*60, status:'blue', product:'SP-A', qty:800 },
            { id:'DH-0004', station:'TSX-02', start: 14*60, end: 16*60, status:'red', product:'SP-C', qty:450, reason:'Thiếu NVL' },
            { id:'DH-0007', station:'UNS-01', start: 0, end: 0, status:'grey', product:'SP-D', qty:300 },
            { id:'DH-0008', station:'TSX-02', start: 9*60, end: 12*60, status:'yellow', product:'SP-E', qty:200, reason: 'Chờ kiểm tra' },
            { id:'DH-0009', station:'TSX-03', start: 6*60, end: 9*60, status:'green', product:'SP-F', qty:1000 },
            { id:'DH-0010', station:'TSX-01', start: 20*60, end: 22*60, status:'grey', product:'SP-G', qty:250 },
            { id:'DH-0011', station:'UNS-01', start: 0, end: 0, status:'grey', product:'SP-A', qty:500 },
        ];

        const fmtTime = min => min > 0 ? `${String(Math.floor(min/60)%24).padStart(2,'0')}:${String(min%60).padStart(2,'0')}` : '---';

        const planProducts = ['Bê Tông Asphalt', 'Gạch Terrazzo', 'Bê Tông Đúc Sẵn', 'Gạch Không Nung'];
        let productionPlanData = [
            { month: '01/2025', company: 'Công ty Sản xuất SicoX', isCollapsed: false, metrics: { 'Sản lượng kế hoạch': [1000, 1000, 1000, 1000], 'Tồn kho hiện tại': [200, 50, 70, 80], 'SX dự phòng': [0, 0, 0, 0], 'Sản lượng cần sản xuất': [800, 950, 930, 920], } },
            { month: '02/2025', company: 'Công ty Sản xuất SicoX', isCollapsed: true, metrics: { 'Sản lượng kế hoạch': [900, 900, 900, 900], 'Tồn kho hiện tại': [200, 50, 70, 80], 'SX dự phòng': [0, 0, 0, 0], 'Sản lượng cần sản xuất': [700, 850, 830, 820], } },
        ];

        // --- GLOBAL SELECTORS ---
        const body = document.body;
        const getEl = id => document.getElementById(id);

        // --- RENDER FUNCTIONS (DECLARE ALL) ---
        let renderAll, renderTracksAndStations, renderUnscheduled, renderKanbanBoard, renderOrderList, renderProductionPlan, renderStationList, renderProductList, renderBomDetail;

        // --- NAVIGATION & SIDEBAR ---
        const sidebarToggle = getEl('sidebarToggle');
        const navLinks = document.querySelectorAll('.sidebar-link');
        const pages = document.querySelectorAll('.page');
        const setSidebarState = (collapsed) => {
            body.classList.toggle('sidebar-collapsed', collapsed);
            sidebarToggle.querySelector('i').className = collapsed ? 'ph ph-caret-double-right text-xl' : 'ph ph-caret-double-left text-xl';
            localStorage.setItem('sidebarCollapsed', collapsed);
        };
        setSidebarState(localStorage.getItem('sidebarCollapsed') === 'true');
        sidebarToggle.addEventListener('click', () => setSidebarState(!body.classList.contains('sidebar-collapsed')));
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('data-page');
                pages.forEach(p => p.classList.remove('active'));
                getEl(pageId)?.classList.add('active');
                navLinks.forEach(n => n.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // --- TABBING LOGIC (SCHEDULING PAGE) ---
        const tabButtons = document.querySelectorAll('#scheduling .tab-btn');
        const scheduleViews = document.querySelectorAll('#scheduling .schedule-view');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const viewId = button.dataset.view;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                scheduleViews.forEach(view => view.id === viewId ? view.classList.add('active') : view.classList.remove('active'));
            });
        });
        
        // --- MODAL HANDLING ---
        const openModal = (modalId) => getEl(modalId)?.classList.remove('hidden');
        const closeModal = (modalId) => getEl(modalId)?.classList.add('hidden');
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').classList.add('hidden')));

        // --- GANTT CHART LOGIC ---
        const tracksEl = getEl('tracks'), stationsEl = getEl('stations'),
            timeGridEl = getEl('timeGrid'), timeHeadScrollEl = getEl('timeHeadScroll'),
            nowMarkerEl = getEl('nowMarker'), zoomRange = getEl('zoom'),
            unscheduledDropzone = getEl('unscheduled-dropzone');

        const getColW = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--col-w'));
        const minutesToLeft = min => (min/60) * getColW();
        const leftToMinutes = left => Math.round((left / getColW()) * 60);
        const minutesToWidth = (start,end) => ((end-start)/60) * getColW();
        
        renderTracksAndStations = () => {
            const scheduledStations = stationsData.filter(s => !s.unscheduled);
            stationsEl.innerHTML = '';
            tracksEl.innerHTML = '';
            tracksEl.appendChild(nowMarkerEl);

            scheduledStations.forEach((station, index) => {
                const stationRow = document.createElement('div');
                stationRow.className = 'station';
                stationRow.innerHTML = `<div><div class="font-semibold">${station.name}</div><div class="station-sub">${station.workshop || ''}</div></div>`;
                stationsEl.appendChild(stationRow);

                const track = document.createElement('div');
                track.className = 'track track-timeline';
                track.dataset.stationId = station.id;
                track.dataset.stationIndex = index;
                
                ordersData.filter(o => o.station === station.id).forEach(order => {
                    const bar = document.createElement('div');
                    bar.className = `order ${order.status}`;
                    bar.dataset.id = order.id;
                    bar.style.left = minutesToLeft(order.start) + 'px';
                    bar.style.width = minutesToWidth(order.start, order.end) + 'px';
                    bar.innerHTML = `<span class="font-bold text-xs">${order.id}</span><span class="text-xs opacity-80">${order.product}</span>`;
                    bar.addEventListener('click', () => openOrderModal(order.id));
                    track.appendChild(bar);
                });
                tracksEl.appendChild(track);
            });
        };
        
        renderUnscheduled = () => {
            unscheduledDropzone.innerHTML = '';
            ordersData.filter(o => stationsData.find(s => s.id === o.station)?.unscheduled).forEach(order => {
                const card = document.createElement('div');
                card.className = 'p-3 bg-white rounded-md shadow-sm border cursor-grab';
                card.dataset.id = order.id;
                card.draggable = true;
                card.innerHTML = `
                    <p class="font-semibold text-sm">${order.id}</p>
                    <p class="text-xs text-slate-600 mt-1">${order.product}</p>
                    <p class="text-xs text-slate-400 mt-2">Chưa xếp lịch</p>`;
                card.addEventListener('click', () => openOrderModal(order.id));
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', order.id);
                    e.target.classList.add('dragging');
                });
                card.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                unscheduledDropzone.appendChild(card);
            });
        };
        
        tracksEl.addEventListener('dragover', (e) => { e.preventDefault(); const track = e.target.closest('.track-timeline'); if (track) { document.querySelectorAll('.track.drop-hover').forEach(t => t.classList.remove('drop-hover')); track.classList.add('drop-hover'); } });
        tracksEl.addEventListener('dragleave', (e) => { e.target.closest('.track-timeline')?.classList.remove('drop-hover'); });
        tracksEl.addEventListener('drop', (e) => {
            e.preventDefault();
            const track = e.target.closest('.track-timeline');
            track?.classList.remove('drop-hover');
            const orderId = e.dataTransfer.getData('text/plain');
            const order = ordersData.find(o => o.id === orderId);
            if (track && order) {
                const stationId = track.dataset.stationId;
                const rect = track.getBoundingClientRect();
                const startPos = e.clientX - rect.left;
                const startMin = leftToMinutes(startPos);
                order.station = stationId;
                order.start = startMin;
                order.end = startMin + 120; // Default duration 2 hours
                order.status = 'grey';
                renderAll();
            }
        });

        // --- ORDER LIST PAGE LOGIC ---
        renderOrderList = (filter = '') => {
            const tableBody = getEl('orderListTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const statusMap = { grey: { text: 'Chưa bắt đầu', class: 'grey' }, blue: { text: 'Đang làm', class: 'blue' }, yellow: { text: 'Cảnh báo', class: 'yellow' }, red: { text: 'Chậm', class: 'red' }, green: { text: 'Hoàn thành', class: 'green' } };
            const filteredOrders = ordersData.filter(o => o.id.toLowerCase().includes(filter) || o.product.toLowerCase().includes(filter));
            filteredOrders.forEach(order => {
                const station = stationsData.find(s => s.id === order.station);
                let statusInfo = statusMap[order.status] || { text: 'Không xác định', class: 'grey' };
                if (station?.unscheduled) { statusInfo = { text: 'Chưa xếp lịch', class: 'grey' }; }
                const row = `<tr class="hover:bg-slate-50"><td class="p-3 font-semibold text-slate-800">${order.id}</td><td class="p-3">${order.product}</td><td class="p-3">${order.qty.toLocaleString('vi-VN')}</td><td class="p-3">${station ? station.name : 'N/A'}</td><td class="p-3 font-mono">${fmtTime(order.start)}</td><td class="p-3 font-mono">${fmtTime(order.end)}</td><td class="p-3 text-center"><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td><td class="p-3"><button class="btn !h-8 !px-2 edit-order-btn" data-id="${order.id}"><i class="ph ph-pencil-simple"></i></button></td></tr>`;
                tableBody.innerHTML += row;
            });
            tableBody.querySelectorAll('.edit-order-btn').forEach(btn => { btn.addEventListener('click', () => openOrderModal(btn.dataset.id)); });
        };
        getEl('orderListSearch')?.addEventListener('input', e => renderOrderList(e.target.value.toLowerCase()));
        getEl('addNewOrderFromListBtn')?.addEventListener('click', () => openOrderModal());

        // --- KANBAN BOARD LOGIC (UPDATED) ---
        renderKanbanBoard = () => {
            const cols = { unscheduled: getEl('kanban-col-unscheduled'), grey: getEl('kanban-col-grey'), active: getEl('kanban-col-active'), green: getEl('kanban-col-green') };
            const counts = { unscheduled: 0, grey: 0, active: 0, green: 0 };
            const statusConfig = {
                unscheduled: { color: 'slate-300', icon: '' },
                grey: { color: 'slate-500', icon: '' },
                blue: { color: 'blue-600', icon: '' },
                yellow: { color: 'yellow-500', icon: '<i class="ph-fill ph-warning-circle text-yellow-500"></i>', textColor: 'text-yellow-600' },
                red: { color: 'red-600', icon: '<i class="ph-fill ph-x-circle text-red-600"></i>', textColor: 'text-red-600' },
                green: { color: 'green-600', icon: '' },
            };
            Object.values(cols).forEach(col => { if(col) col.innerHTML = ''; });
            
            ordersData.forEach(order => {
                const station = stationsData.find(s => s.id === order.station);
                let colKey, statusKey;
                
                if (station?.unscheduled) { colKey = 'unscheduled'; statusKey = 'unscheduled'; }
                else if (order.status === 'green') { colKey = 'green'; statusKey = 'green'; }
                else if (order.status === 'grey') { colKey = 'grey'; statusKey = 'grey'; }
                else { colKey = 'active'; statusKey = order.status; }
                
                if (!cols[colKey]) return;
                counts[colKey]++;
                
                const config = statusConfig[statusKey];
                let cardHtml = `
                <div class="p-3 bg-white rounded-md shadow-sm border-l-4 border-${config.color} cursor-pointer" data-id="${order.id}">
                    <div class="flex justify-between items-start">
                        <p class="font-semibold text-sm text-slate-800">${order.id}</p>
                        ${config.icon}
                    </div>
                    <p class="text-xs text-slate-600 mt-1">${productsData.find(p => p.code === order.product)?.name || 'N/A'}</p>
                    <p class="text-xs text-slate-400 mt-2">${station.name}</p>
                    ${order.reason ? `<p class="text-xs font-semibold mt-2 ${config.textColor}">${order.reason}</p>` : ''}
                </div>`;
                cols[colKey].innerHTML += cardHtml;
            });
            
            for (const key in counts) { getEl(`kanban-count-${key}`).textContent = counts[key]; }
            document.querySelectorAll('#kanban-view [data-id]').forEach(card => card.addEventListener('click', () => openOrderModal(card.dataset.id)));
        };

        // --- PRODUCTION PLAN LOGIC ---
        renderProductionPlan = () => {
            const thead = getEl('productionPlanThead'), tbody = getEl('productionPlanTbody');
            if (!thead || !tbody) return;
            thead.innerHTML = `<tr><th class="w-1/4 p-3">Nội dung</th>${planProducts.map(p => `<th class="p-3 text-right">${p}</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            const numFormatter = new Intl.NumberFormat('vi-VN');
            productionPlanData.forEach((monthData, index) => {
                tbody.innerHTML += `<tr class="month-row bg-slate-50 font-bold ${monthData.isCollapsed ? 'collapsed' : ''}" data-index="${index}"><td><div class="flex items-center gap-2 p-3"><i class="ph ph-caret-down"></i><span>${monthData.month}</span></div></td><td colspan="${planProducts.length}"></td></tr>`;
                if (!monthData.isCollapsed) {
                    tbody.innerHTML += `<tr class="metric-row-l2 font-semibold"><td>${monthData.company}</td><td colspan="${planProducts.length}"></td></tr>`;
                    for (const [metricName, values] of Object.entries(monthData.metrics)) {
                        const isTotalRow = metricName === 'Sản lượng cần sản xuất';
                        tbody.innerHTML += `<tr class="${isTotalRow ? 'metric-row-l3 total-row' : 'metric-row-l3'}"><td>${metricName}</td>${values.map(val => `<td class="text-right font-mono">${numFormatter.format(val)}</td>`).join('')}</tr>`;
                    }
                }
            });
        };
        getEl('productionPlanTbody')?.addEventListener('click', (e) => {
            const monthRow = e.target.closest('.month-row');
            if (monthRow) { const index = parseInt(monthRow.dataset.index); productionPlanData[index].isCollapsed = !productionPlanData[index].isCollapsed; renderProductionPlan(); }
        });

        // --- STATION CONFIG LOGIC (UPDATED) ---
        const renderWorkSchedule = (scheduleId) => {
            const schedule = workingSchedules[scheduleId];
            if (!schedule) return '<p class="text-sm text-slate-500">Chưa có lịch làm việc.</p>';
            let tableHtml = `<table class="w-full text-sm text-left work-schedule-table"><thead class="bg-slate-50 text-xs uppercase"><tr><th>Ca</th><th>Thứ</th><th>Buổi</th><th>Từ giờ</th><th>Đến giờ</th></tr></thead><tbody>`;
            schedule.periods.forEach(p => {
                tableHtml += `<tr class="border-b"><td>${p.name}</td><td>${p.day}</td><td>${p.period}</td><td class="font-mono">${p.from}</td><td class="font-mono">${p.to}</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        };
        renderStationList = (filter = '') => {
            const listEl = getEl('stationList');
            if(!listEl) return;
            listEl.innerHTML = stationsData
                .filter(s => !s.unscheduled && (s.id.toLowerCase().includes(filter) || s.name.toLowerCase().includes(filter)))
                .map(s => `<div data-id="${s.id}" class="p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><p class="font-semibold text-sm">${s.name}</p><p class="text-xs text-slate-500">${s.id} - ${s.workshop}</p></div>`).join('');
            
            listEl.querySelectorAll('[data-id]').forEach(item => item.addEventListener('click', () => {
                getEl('stationDetailView').classList.remove('hidden');
                getEl('stationEmptyView').classList.add('hidden');
                const station = stationsData.find(s => s.id === item.dataset.id);
                getEl('stationDetailId').textContent = station.id;
                getEl('stationDetailName').textContent = station.name;
                getEl('stationDetailWorkshop').textContent = station.workshop;
                getEl('stationDetailEfficiency').textContent = station.efficiency + '%';
                getEl('stationDetailCapacity').textContent = station.capacity + ' sp/giờ';
                getEl('stationWorkSchedule').innerHTML = renderWorkSchedule(station.scheduleId);
            }));
        };
        getEl('stationSearch')?.addEventListener('input', e => renderStationList(e.target.value.toLowerCase()));

        // --- BOM CONFIG LOGIC ---
        renderProductList = (filter = '') => {
            const listEl = getEl('productList');
            if(!listEl) return;
            listEl.innerHTML = productsData.filter(p => p.code.toLowerCase().includes(filter) || p.name.toLowerCase().includes(filter)).map(p => `<div data-code="${p.code}" class="p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><p class="font-semibold text-sm">${p.name}</p><p class="text-xs text-slate-500">${p.code}</p></div>`).join('');
            listEl.querySelectorAll('[data-code]').forEach(item => item.addEventListener('click', () => renderBomDetail(item.dataset.code)));
        };
        renderBomDetail = (productCode) => {
            const product = productsData.find(p => p.code === productCode);
            if(!product) return;
            getEl('bomDetailView').classList.remove('hidden');
            getEl('bomEmptyView').classList.add('hidden');
            getEl('bomProductName').textContent = product.name;
            getEl('bomProductCode').textContent = product.code;
            getEl('bomComponentList').innerHTML = product.components.map(c => `<tr class="border-b"><td class="p-2">${c.code}</td><td class="p-2">${c.name}</td><td class="p-2">${c.qty}</td><td class="p-2">${c.unit}</td></tr>`).join('');
        };
        getEl('bomSearch')?.addEventListener('input', e => renderProductList(e.target.value.toLowerCase()));

        // --- ORDER FORM MODAL LOGIC ---
        const openOrderModal = (orderId = null) => {
            const form = getEl('orderForm'); form.reset();
            const stationSelect = getEl('form-modal-station');
            const productSelect = getEl('form-modal-product');
            stationSelect.innerHTML = stationsData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            productSelect.innerHTML = productsData.map(p => `<option value="${p.code}">${p.name} (${p.code})</option>`).join('');
            if (orderId) {
                const order = ordersData.find(o => o.id === orderId); if (!order) return;
                getEl('orderFormModalTitle').textContent = 'Chỉnh sửa Lệnh Sản xuất';
                form.elements.editingId.value = order.id; form.elements.id.value = order.id; form.elements.product.value = order.product; form.elements.qty.value = order.qty;
                form.elements.station.value = order.station; form.elements.start.value = order.start > 0 ? fmtTime(order.start) : ''; form.elements.end.value = order.end > 0 ? fmtTime(order.end) : '';
                form.elements.status.value = order.status; form.elements.reason.value = order.reason || '';
            } else {
                getEl('orderFormModalTitle').textContent = 'Thêm Lệnh Sản Xuất Mới';
                form.elements.editingId.value = ''; form.elements.station.value = 'UNS-01';
            }
            openModal('orderFormModal');
        };
        getEl('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const startVal = formData.get('start'), endVal = formData.get('end');
            const startMin = startVal ? parseInt(startVal.split(':')[0])*60 + parseInt(startVal.split(':')[1]) : 0;
            const endMin = endVal ? parseInt(endVal.split(':')[0])*60 + parseInt(endVal.split(':')[1]) : 0;
            const orderData = { id: formData.get('id'), product: formData.get('product'), qty: parseInt(formData.get('qty')), station: formData.get('station'), start: startMin, end: endMin, status: formData.get('status'), reason: formData.get('reason') };
            const editingId = formData.get('editingId');
            if (editingId) { const index = ordersData.findIndex(o => o.id === editingId); if (index !== -1) ordersData[index] = orderData; } 
            else { ordersData.push(orderData); }
            renderAll();
            closeModal('orderFormModal');
        });

        // --- DASHBOARD CHARTS ---
        new Chart(getEl('productionByStationChart').getContext('2d'), { type: 'bar', data: { labels: stationsData.filter(s => !s.unscheduled).map(s => s.name), datasets: [{ label: 'Sản lượng', data: [3200, 2800, 4100, 2100], backgroundColor: '#0D47A1', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
        new Chart(getEl('orderStatusChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Hoàn thành', 'Đang thực hiện', 'Cảnh báo', 'Chậm tiến độ', 'Chưa bắt đầu', 'Chưa xếp lịch'], datasets: [{ data: [1, 1, 1, 1, 1, 2], backgroundColor: ['#16a34a', '#0D47A1', '#f59e0b', '#dc2626', '#64748b', '#cbd5e1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' } });
        
        // --- INITIAL RENDER ---
        renderAll = () => {
            renderTracksAndStations();
            renderUnscheduled();
            renderKanbanBoard();
            renderOrderList();
            renderProductionPlan();
            renderStationList();
            renderProductList();
        };
        
        renderAll();
    });
    </script>
</body>
</html>
